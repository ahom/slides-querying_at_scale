<!doctype html>
<html lang="en">

    <head>
        <meta charset="utf-8">

        <title>Querying at Scale</title>

        <meta name="description" content="MapReduce and MongoDB's Aggregation Framework">
        <meta name="author" content="Antoine Hom">

        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

        <link rel="stylesheet" href="css/reveal.css">
        <link rel="stylesheet" href="css/theme/league.css" id="theme">

        <!-- Code syntax highlighting -->
        <link rel="stylesheet" href="lib/css/zenburn.css">

        <!-- Printing and PDF exports -->
        <script>
            var link = document.createElement( 'link' );
            link.rel = 'stylesheet';
            link.type = 'text/css';
            link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
            document.getElementsByTagName( 'head' )[0].appendChild( link );
        </script>

        <!--[if lt IE 9]>
        <script src="lib/js/html5shiv.js"></script>
        <![endif]-->

        <!-- http://ethanschoonover.com/solarized -->
        <style type="text/css">
        :root {
            --yellow-color: #b58900;
            --orange-color: #cb4b16;
            --red-color: #dc322f;
            --magenta-color: #d33682;
            --violet-color: #6c71c4;
            --blue-color: #268bd2;
            --cyan-color: #2aa198;
            --green-color: #859900;
        }

        svg {
            width:100%;
            height:100%;
            top:0;
            left:0;
            z-index:-1;
        }
        </style>
    </head>

    <body>
        <div class="reveal">

            <!-- Any section element inside of this container is displayed as a slide -->
            <div class="slides">
                <section>
                    <h1>Querying at Scale</h1>
                    <h3>MapReduce and MongoDB's Aggregation Framework</h3>
                    <p>
                        <small>Created by <a href="https://rndwww.nce.amadeus.net/confluence/display/~ahom">Antoine Hom</a> / <a href="https://rndwww.nce.amadeus.net/confluence/display/DRQ">R&amp;D-AIR-TDF-FRA-RAC-DRQ</a></small>
                    </p>
                </section>

                <section>
                    <h2>What do I mean by Scale?</h2>
                    <div class="fragment">
                        Querying a database in a cluster (Most NoSQL databases)<br><br>
                        <svg height="150">
                            <use xlink:href="#svg_query_cluster" />
                        </svg>
                    </div>
                    <div class="fragment">
                        <hr>
                        Vs a single node (Traditional RDBMS)<br><br>
                        <svg height="100">
                            <use xlink:href="#svg_query_node" />
                        </svg>
                    </div>
                </section>

                <section>
                    <h2>Why should you care about how it works?</h2>
                    <ul>
                        <li class="fragment">
                            As a <strong>user</strong>, you should <strong>not</strong>, unless:
                            <ul>
                                <li>You are curious</li>
                                <li>You intend to write some MapReduce someday</li>
                            </ul>
                        </li>
                        <li class="fragment">As a <strong>developer</strong>, you <strong>should</strong>, do I really need to explain why?</li>
                    </ul>
                </section>

                <section>
                    <h2>How to make queries scale?</h2>
                    <div class="fragment">
                        Run the query on each node<br><br>
                        <svg height="100">
                            <use xlink:href="#svg_query_scale_top" />
                        </svg>
                    </div>
                    <div class="fragment">
                        <svg height="200">
                            <use xlink:href="#svg_query_scale_bot" />
                        </svg>
                        <br>???
                        <br>Concatenate the results at the end
                    </div>
                </section>

                <section>
                    <h2>Well...</h2>
                    <ul>
                        <li class="fragment">The "Concatenation" step needs to <strong>understand</strong> how to do its job.</li>
                        <li class="fragment">This step is run on a single node, this is a <strong>choke point</strong></li>
                    </ul>
                </section>

                <section>
                    <h2>Let's talk about a story</h2>

                    <p>Your boss</p>

                    <blockquote>
                        &ldquo;I need you to produce an interline reports for each partner of &lt;unnamed airline&gt; for this year. I need that for when I come back next week from holidays! Use whatever you need.&rdquo;
                    </blockquote>

                    <ul>
                        <li class="fragment">The &lt;unnamed airline&gt; likes paper, all the tickets are <strong>printed</strong>.</li>
                        <li class="fragment">There are <strong>1 million</strong> of them.</li>
                        <li class="fragment">You <strong>can't use computers</strong>, apparently they don't like them.</li>
                    </ul>
                </section>

                <section>
                    <h2>What should you do?</h2>

                    <ul>
                        <li class="fragment">No, you <strong>can't resign</strong>...</li>
                        <li class="fragment">You're smart so you leave one team working on <strong>production support</strong>!</li>
                        <li class="fragment">Ok, let's be serious.</li>
                    </ul>
                </section>

                <section>
                    <h2>What should you do? (for real)</h2>

                    <h3>Divide and Conquer</h3>
                    <p>You create 4 groups of people:</p>
                    <ul>
                        <li class="fragment">the Mappers</li>
                        <li class="fragment">the Groupers</li>
                        <li class="fragment">the Reducers</li>
                        <li class="fragment">the Master (Yep that's you!)</li>
                    </ul>
                </section>

                <section>
                    <h2>Getting through all the tickets</h2>
                    <h3>Mappers</h3>

                    <svg height="400">
                        <use xlink:href="#svg_mapper_job" />
                    </svg>
                </section>

                <section>
                    <h2>Grouping by partner</h2>
                    <h3>Groupers</h3>

                    <svg height="400">
                        <use xlink:href="#svg_grouper_job" />
                    </svg>
                </section>

                <section>
                    <h2>Summing it</h2>

                    <h3>Reducers</h3>

                    <svg height="400">
                        <use xlink:href="#svg_reducer_job" />
                    </svg>
                </section>

                <section>
                    <h2>But what did the Master do?</h2>

                    <ul>
                        <li class="fragment"><strong>Splitted</strong> the tickets evenly for the Mappers</li>
                        <li class="fragment"><strong>Coordinated</strong> people</li>
                        <li class="fragment">If some people <strong>failed</strong>, gave his job to someone else</li>
                        <li class="fragment">Got the <strong>results back</strong></li>
                        <li class="fragment">Got the <strong>credits</strong> I guess</li>
                    </ul>
                </section>

                <section>
                    <h2>MapReduce</h2>
                    <svg height="500">
                        <use xlink:href="#svg_mapreduce" />
                    </svg>
                </section>

                <section>
                    <h2>Recursive Reduce</h2>
                    <svg height="500">
                        <use xlink:href="#svg_recursive_reduce" />
                    </svg>
                </section>

                <section>
                    <h2>Important property of the Reduce function</h2>
                    <h3>Associativity</h3>
                    <svg class="fragment" height="100">
                        <use xlink:href="#svg_reduce_associative" />
                    </svg>
                    <br><br>
                    <pre class="fragment"><code>reduce([ reduce([ A, B ]), C ]) = reduce([ A, reduce([ B, C ]) ])</pre></code>
                </section>

                <section>
                    <h2>Sum</h2>
                    <pre><code data-trim>
SELECT SUM(amount)
FROM SALES
GROUP BY agency;
                    </code></pre>
                    <table class="stretch">
                        <tr class="fragment">
                            <td>Map</td>
                            <td><pre><code data-trim>
function(sale) {
    emit(sale.agency, sale.amount);
}
                            </code></pre></td>
                        </tr>
                        <tr class="fragment">
                            <td>Reduce</td>
                            <td><pre><code data-trim>
function(agency, amounts) {
    return sum(amounts);
}
                            </code></pre></td>
                        </tr>
                    </table>
                </section>

                <section>
                    <h2>Average</h2>
                    <pre><code data-trim>
SELECT AVG(amount)
FROM SALES
GROUP BY month;
                    </code></pre>
                    <table class="stretch">
                        <tr class="fragment">
                            <td>Map</td>
                            <td><pre><code data-trim>
function(sale) {
    emit(sale.month, sale.amount);
}
                            </code></pre></td>
                        </tr>
                        <tr class="fragment">
                            <td>Reduce</td>
                            <td><pre><code data-trim>
function(month, amounts) {
    return avg(amounts);
}
                            </code></pre></td>
                        </tr>
                    </table>
                    <h2 class="fragment" style="color: var(--red-color)">Wrong</h3>
                </section>

                <section>
                    <h2>Average (For Real)</h2>
                    <pre><code data-trim>
SELECT AVG(amount)
FROM SALES
GROUP BY month;
                    </code></pre>
                    <pre class="fragment"><code data-trim contenteditable>
function(sale) {
    emit(sale.month, {
        count: 1,
        sum: sale.amount
    });
}
                    </code></pre>
                    <pre class="fragment"><code data-trim contenteditable>
function(month, values) {
    return {
        count: sum(value.count for value in values),
        sum: sum(value.sum for value in values)
    };
}
                    </code></pre>
                </section>

                <section>
                    <h2>Evolutions ? TODO</h2>
                    <p>HDFS / MapR?</p>
                    <p>Spark ?</p>
                </section>

                <section>
                    <h2>What about MongoDB ?</h2>
                    <ul>
                        <li>You can do plain MapReduce</li>
                        <li>But you can also use the Aggregation Framework</li>
                    </ul>
                </section>

                <section>
                    <h2>What is the aggregation Framework ?</h2>
                    <ul>
                        <li>Simplified MapReduce</li>
                        <li>Written in C++ for speed</li>
                        <li>Splitting the query is handled by the engine, but of course you have less freedom</li>
                    </ul>
                </section>

                <section>
                    <h2>How to write a query using Aggregation Framework ?</h2>
                    <p>Think of it as a pipeline, a series of processes your data will go through, one by one</p>
                    <p>Several operations for a pipeline ... TODO</p>
                </section>

                <section>
                    <h2>$match (filter)</h2>
                    <h3>SQL WHERE</h3>
                    <svg height="320">
                        <use xlink:href="#svg_af_match" />
                    </svg>
                </section>

                <section>
                    <h2>$project (reshape)</h2>
                    <h3>SQL SELECT</h3>
                    <svg height="320">
                        <use xlink:href="#svg_af_project" />
                    </svg>
                </section>

                <section>
                    <h2>$group</h2>
                    <h3>SQL GROUP BY</h3>
                    <svg height="320">
                        <use xlink:href="#svg_af_group" />
                    </svg>
                </section>

                <section>
                    <h2>$unwind</h2>
                    <svg height="320">
                        <use xlink:href="#svg_af_unwind" />
                    </svg>
                </section>

                <section>
                    <h2>SQL to Aggregation Framework</h2>
                    <svg height="400">
                        <use xlink:href="#svg_sql_to_agg_framework" />
                    </svg>
                </section>

                <section>
                    <h2>Ok let's write some queries</h2>
                    <p>...</p>
                </section>

                <section>
                    <h2>How do you do that ?</h2>
                    <p>...</p>
                </section>

                <section>
                    <h2>Food for thoughs</h2>
                    <p>...</p>
                </section>

                <section>
                    <h2>New operators to come !</h2>
                    <p>...</p>
                </section>

                <section>
                    <h2>How does it split the query</h2>
                    <p>...</p>
                </section>
            </div>
        </div>

        <script src="lib/js/head.min.js"></script>
        <script src="js/reveal.js"></script>

        <script>

            // Full list of configuration options available at:
            // https://github.com/hakimel/reveal.js#configuration
            Reveal.initialize({
                controls: true,
                progress: true,
                history: true,
                center: true,

                transition: 'fade', // none/fade/slide/convex/concave/zoom

                // Optional reveal.js plugins
                dependencies: [
                    { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
                    { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
                    { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
                    { src: 'plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
                    { src: 'plugin/zoom-js/zoom.js', async: true },
                    { src: 'plugin/notes/notes.js', async: true },
                    { src: 'plugin/animate/animate.js', async: true, condition: function() { return !!document.body.classList; } }
                ]
            });

        </script>

        <svg width="0" height="0">
            <defs>
                <marker id="arrowhead" viewBox="0 0 10 10" refX="1" refY="5" markerWidth="6" markerHeight="6" orient="auto">
                    <path fill="white" stroke="white" d="M 0 0 L 10 5 L 0 10 z" />
                </marker>

                <symbol id="svg_user" viewBox="0 0 654.348 654.348">
                    <path fill="inherit" d="M466.121,401.586c52.287-41.184,85.985-104.92,85.985-176.654C552.106,100.708,451.398,0,327.174,0
                        S102.242,100.708,102.242,224.932c0,71.733,33.699,135.47,85.985,176.654C94.471,449.373,28.484,543.764,21.184,654.348h40.958
                        c7.893-103.549,75.209-190.332,167.861-226.793c29.446,14.15,62.327,22.311,97.171,22.311c34.865,0,67.725-8.16,97.17-22.311
                        c92.652,36.461,159.968,123.244,167.861,226.793h40.958C625.884,543.764,559.876,449.373,466.121,401.586z M327.174,408.969
                        c-101.649,0-184.036-82.387-184.036-184.037c0-101.649,82.387-184.035,184.036-184.035s184.036,82.386,184.036,184.035
                        C511.209,326.582,428.823,408.969,327.174,408.969z"/>
                </symbol>
                <symbol id="svg_database" viewBox="0 0 32 32">
                    <path fill="inherit" d="M16,0C9.256,0,2,2.033,2,6.5v19C2,29.965,9.256,32,16,32c6.743,0,14-2.035,14-6.5v-19
                        C30,2.033,22.742,0,16,0z M28,25.5c0,2.484-5.373,4.5-12,4.5c-6.628,0-12-2.016-12-4.5v-3.736C6.066,23.893,11.05,25,16,25
                        s9.934-1.107,12-3.236V25.5z M28,19.5h-0.004c0,0.01,0.004,0.021,0.004,0.031C28,22,22.627,24,16,24S4,22,4,19.531
                        c0-0.01,0.004-0.021,0.004-0.031H4v-3.736C6.066,17.893,11.05,19,16,19s9.934-1.107,12-3.236V19.5z M28,13.5h-0.004
                        c0,0.01,0.004,0.021,0.004,0.031C28,16,22.627,18,16,18S4,16,4,13.531c0-0.01,0.004-0.021,0.004-0.031H4v-3.436
                        C6.621,12.061,11.425,13,16,13s9.379-0.939,12-2.936V13.5z M16,11C9.372,11,4,8.984,4,6.5C4,4.014,9.372,2,16,2
                        c6.627,0,12,2.014,12,4.5C28,8.984,22.627,11,16,11z"/>
                    <circle fill="inherit" cx="25" cy="26" r="1"/>
                    <circle fill="inherit" cx="25" cy="20" r="1"/>
                    <circle fill="inherit" cx="25" cy="14" r="1"/>
                </symbol>
                <symbol id="svg_process" viewBox="0 0 32 32">
                    <path fill="inherit" d="M19.945,22l6.008-8L32,22h-4v2c0,3.309-2.691,6-6,6H10c-3.309,0-6-2.691-6-6v-2h4v2c0,1.102,0.898,2,2,2h12c1.102,0,2-0.898,2-2v-2H19.945z"/>
                    <path fill="inherit" d="M12.055,10l-6.008,8L0,10h4V8c0-3.309,2.691-6,6-6h12c3.309,0,6,2.691,6,6v2h-4V8c0-1.102-0.898-2-2-2H10C8.898,6,8,6.898,8,8v2H12.055z"/>
                </symbol>
                <symbol id="svg_flight_ticket" viewBox="0 0 476.801 476.801">
                    <path fill="inherit" d="M468.801,115.2H8c-4.418,0-8,3.582-8,8v230.4c0,4.418,3.582,8,8,8h460.801c4.418,0,8-3.582,8-8V123.2  C476.801,118.782,473.219,115.2,468.801,115.2z M460.801,345.601h-176v-16.616c0-4.418-3.582-8-8-8s-8,3.582-8,8v16.616H16V131.2  h252.801v145.599c0,4.418,3.582,8,8,8s8-3.582,8-8V131.2h176V345.601z M238.4,237.798L238.4,237.798  c0.001,11.888-12.362,21.525-27.613,21.525l-41.421-2.691l-20.301,67.417h-21.12v-70.108l-41.686-2.708l-10.726,27.257  l-16.389,3.927v-32.945l-0.281-0.019c-7.777-0.505-13.759-5.573-13.759-11.656h-0.001c0-6.083,5.982-11.151,13.759-11.656  l0.281-0.019v-32.132l16.389,3.926l10.414,26.465l42.408-2.755v-69.627h20.301l20.973,66.946l41.159-2.674  C226.037,216.273,238.4,225.91,238.4,237.798z M448,223.625c0,4.418-3.582,8-8,8H324.801c-4.418,0-8-3.582-8-8s3.582-8,8-8H440  C444.418,215.625,448,219.207,448,223.625z M448,310.4c0,4.418-3.582,8-8,8H324.801c-4.418,0-8-3.582-8-8s3.582-8,8-8H440  C444.418,302.4,448,305.982,448,310.4z M448,281.601c0,4.418-3.582,8-8,8H334.775c-4.418,0-8-3.582-8-8s3.582-8,8-8H440  C444.418,273.601,448,277.183,448,281.601z M448,252.425c0,4.418-3.582,8-8,8h-86.399c-4.418,0-8-3.582-8-8s3.582-8,8-8H440  C444.418,244.425,448,248.007,448,252.425z M310.4,203.2H440c4.418,0,8-3.582,8-8V152c0-4.418-3.582-8-8-8H310.4  c-4.418,0-8,3.582-8,8v43.2C302.4,199.618,305.982,203.2,310.4,203.2z M318.4,160H432v27.2H318.4V160z"/>
                </symbol>
                <symbol id="svg_box" viewBox="0 0 551.852 551.852">
                    <path fill="inherit" d="M545.933,106.575l0.377-0.999L276.049,0L6.228,106.671l-0.881-0.35v0.684l-0.038,0.021l0.038,0.115v338.651  l270.579,106.059l270.617-106.064V106.326L545.933,106.575z M275.797,20.755l91.666,32.829L117.578,150.6l-84.647-33.39   L275.797,20.755z M266.281,527.927L164.94,487.013l-50.859-19.107l-89.396-35.267V134.737l88.499,34.909v74.49l7.887-2.202   l5.33,7.324l7.421-1.732l7.187,7.592l6.272-2.161l10.125,10.041v-75.911l7.877,3.11l100.999,39.834V527.927L266.281,527.927z    M275.948,213.077l-98.808-38.983L420.832,75.33l100.504,40.944L275.948,213.077z M527.218,432.639l-241.612,95.288V230.032   l241.589-95.301v297.901L527.218,432.639L527.218,432.639z"/>
                </symbol>
                <symbol id="svg_documents" viewBox="0 0 256.51 256.51">
                    <path fill="inherit" d="M60.859,112.533c-6.853,0-6.853,10.646,0,10.646c27.294,0,54.583,0,81.875,0c6.865,0,6.865-10.646,0-10.646     C115.442,112.533,88.153,112.533,60.859,112.533z"/>
                    <path fill="inherit" d="M142.734,137.704c-27.292,0-54.581,0-81.875,0c-6.853,0-6.853,10.634,0,10.634c27.294,0,54.583,0,81.875,0     C149.6,148.338,149.6,137.704,142.734,137.704z"/>
                    <path fill="inherit" d="M142.734,161.018c-27.292,0-54.581,0-81.875,0c-6.853,0-6.853,10.633,0,10.633c27.294,0,54.583,0,81.875,0     C149.6,171.65,149.6,161.018,142.734,161.018z"/>
                    <path fill="inherit" d="M142.734,186.184c-27.292,0-54.581,0-81.875,0c-6.853,0-6.853,10.629,0,10.629c27.294,0,54.583,0,81.875,0     C149.6,196.812,149.6,186.184,142.734,186.184z"/>
                    <path fill="inherit" d="M141.17,209.934c-27.302,0-54.601,0-81.89,0c-6.848,0-6.848,10.633,0,10.633c27.289,0,54.588,0,81.89,0     C148.015,220.566,148.015,209.934,141.17,209.934z"/>
                    <path fill="inherit" d="M25.362,58.087V256.61h152.877V85.63l-28.406-27.543H25.362z M165.026,243.393H38.585V71.305h104.443v20.97h21.988     v151.118H165.026z"/>
                    <polygon fill="inherit" points="51.204,27.667 51.204,50.645 64.427,50.645 64.427,40.88 168.875,40.88 168.875,61.85 190.868,61.85      190.868,212.971 185.059,212.971 185.059,226.188 204.086,226.188 204.086,55.205 175.68,27.667    "/>
                    <polygon fill="inherit" points="202.837,0 78.363,0 78.363,22.983 91.581,22.983 91.581,13.218 196.032,13.218 196.032,34.188 218.025,34.188      218.025,185.306 212.221,185.306 212.221,198.523 231.248,198.523 231.248,27.543    "/>
                </symbol>
                <symbol id="svg_empty_document" viewBox="0 0 45.057 45.057">
                    <path fill="inherit" d="M33.431,0H5.179v45.057h34.699V6.251L33.431,0z M36.878,42.056H8.179V3h23.707v4.76h4.992V42.056z"></path>
                </symbol>
                <symbol id="svg_document" viewBox="0 0 45.057 45.057">
                    <path fill="inherit" d="M13.323,13.381c6.418,0,12.834,0,19.252,0c1.613,0,1.613-2.5,0-2.5c-6.418,0-12.834,0-19.252,0     C11.711,10.881,11.711,13.381,13.323,13.381z"></path>
                    <path fill="inherit" d="M32.577,16.798c-6.418,0-12.835,0-19.253,0c-1.612,0-1.612,2.5,0,2.5c6.418,0,12.835,0,19.253,0     C34.188,19.298,34.188,16.798,32.577,16.798z"></path>
                    <path fill="inherit" d="M32.577,22.281c-6.418,0-12.835,0-19.253,0c-1.612,0-1.612,2.5,0,2.5c6.418,0,12.835,0,19.253,0     C34.188,24.781,34.188,22.281,32.577,22.281z"></path>
                    <path fill="inherit" d="M32.577,28.197c-6.418,0-12.835,0-19.253,0c-1.612,0-1.612,2.5,0,2.5c6.418,0,12.835,0,19.253,0     C34.188,30.697,34.188,28.197,32.577,28.197z"></path>
                    <path fill="inherit" d="M32.204,33.781c-6.418,0-12.834,0-19.252,0c-1.612,0-1.612,2.5,0,2.5c6.418,0,12.834,0,19.252,0     C33.817,36.281,33.817,33.781,32.204,33.781z"></path>
                    <path fill="inherit" d="M33.431,0H5.179v45.057h34.699V6.251L33.431,0z M36.878,42.056H8.179V3h23.707v4.76h4.992V42.056z"></path>
                </symbol>
                <symbol id="svg_kvdocument" viewBox="0 0 45.057 45.057">
                    <path fill="inherit" d="M13.323,13.381c6.418,0,12.834,0,19.252,0c1.613,0,1.613-2.5,0-2.5c-6.418,0-12.834,0-19.252,0     C11.711,10.881,11.711,13.381,13.323,13.381z"></path>
                    <path fill="inherit" d="M32.577,16.798c-6.418,0-12.835,0-19.253,0c-1.612,0-1.612,2.5,0,2.5c6.418,0,12.835,0,19.253,0     C34.188,19.298,34.188,16.798,32.577,16.798z"></path>
                    <path fill="inherit" d="M32.577,22.281c-6.418,0-12.835,0-19.253,0c-1.612,0-1.612,2.5,0,2.5c6.418,0,12.835,0,19.253,0     C34.188,24.781,34.188,22.281,32.577,22.281z"></path>
                    <path fill="inherit" d="M32.577,28.197c-6.418,0-12.835,0-19.253,0c-1.612,0-1.612,2.5,0,2.5c6.418,0,12.835,0,19.253,0     C34.188,30.697,34.188,28.197,32.577,28.197z"></path>
                    <path fill="inherit" d="M32.204,33.781c-6.418,0-12.834,0-19.252,0c-1.612,0-1.612,2.5,0,2.5c6.418,0,12.834,0,19.252,0     C33.817,36.281,33.817,33.781,32.204,33.781z"></path>
                    <path fill="inherit" d="M33.431,0H5.179v45.057h34.699V6.251L33.431,0z M36.878,42.056H8.179V3h23.707v4.76h4.992V42.056z"></path>
                    <rect fill="inherit" opacity="0.9" x="8" width="12" height="45.057" />
                </symbol>
                <symbol id="svg_groupdocument" viewBox="0 0 45.057 45.057">
                    <path fill="inherit" d="M13.323,13.381c6.418,0,12.834,0,19.252,0c1.613,0,1.613-2.5,0-2.5c-6.418,0-12.834,0-19.252,0     C11.711,10.881,11.711,13.381,13.323,13.381z"></path>
                    <path fill="inherit" d="M32.577,16.798c-6.418,0-12.835,0-19.253,0c-1.612,0-1.612,2.5,0,2.5c6.418,0,12.835,0,19.253,0     C34.188,19.298,34.188,16.798,32.577,16.798z"></path>
                    <path fill="inherit" d="M32.577,22.281c-6.418,0-12.835,0-19.253,0c-1.612,0-1.612,2.5,0,2.5c6.418,0,12.835,0,19.253,0     C34.188,24.781,34.188,22.281,32.577,22.281z"></path>
                    <path fill="inherit" d="M32.577,28.197c-6.418,0-12.835,0-19.253,0c-1.612,0-1.612,2.5,0,2.5c6.418,0,12.835,0,19.253,0     C34.188,30.697,34.188,28.197,32.577,28.197z"></path>
                    <path fill="inherit" d="M32.204,33.781c-6.418,0-12.834,0-19.252,0c-1.612,0-1.612,2.5,0,2.5c6.418,0,12.834,0,19.252,0     C33.817,36.281,33.817,33.781,32.204,33.781z"></path>
                    <path fill="inherit" d="M33.431,0H5.179v45.057h34.699V6.251L33.431,0z M36.878,42.056H8.179V3h23.707v4.76h4.992V42.056z"></path>
                    <rect fill="inherit" opacity="0.9" x="8" y="2.8" width="29" height="13" />
                </symbol>
                <symbol id="svg_reducedocument" viewBox="0 0 45.057 45.057">
                    <path fill="inherit" d="M33.431,0H5.179v45.057h34.699V6.251L33.431,0z M36.878,42.056H8.179V3h23.707v4.76h4.992V42.056z"></path>
                    <rect fill="inherit" opacity="0.9" x="8" y="2.8" width="29" height="13" />
                    <text x="9" y="36" font-size="20" fill="inherit" font-weight="bold">XX</font>
                </symbol>
                <symbol id="svg_profit" viewBox="0 0 473.302 473.302">
                    <path fill="inherit" d="M303.173,97.537c7.046-1.797,12.326-5.893,5.854-12.725c-0.784-0.818-2.041-0.537-2.61,0.331    c-1.862,2.823-6.119,3.765-11.088,3.63c1.54-0.448,2.759-1.236,3.453-2.514c2.518-4.646,0.114-8.58-3.529-11.874    c-1.312-1.204-2.806-1.957-4.384-2.386c9.801-17.28,20.418-37.918,27.524-57.262c16.664-45.195-52.326,30.931-76.115,17.5    c-23.792-13.415-14.265-55.558-54.709-15.124c-28.477,28.495,15.779,54.594,44.46,67.56c-5.809,0.812-11.608,1.321-17.33,1.31    c-6.437,0-12.859-0.194-19.279-0.723c-5.185-0.418-18.346-0.89-20.805-6.902c-0.796-1.956-3.997-1.097-3.189,0.881    c2.729,6.679,12.178,7.898,18.413,8.722c6.796,0.87,13.704,1.284,20.602,1.368c-0.083,0.011-0.179,0.027-0.263,0.038    c-16.928,2.208-34.011,4.892-50.367,9.896c-5.812,1.781-20.543,5.795-19.393,14.362c0.278,2.079,3.595,2.112,3.315,0    c-1.289-9.656,27.636-14.115,33.599-15.409c16.692-3.62,33.69-5.888,50.693-7.592c-42.608,20.944-99.824,77.461-112.605,148.755    c10.008-3.157,20.642-4.867,31.676-4.867c31.895,0,61.744,14.236,81.898,39.046l0.505,0.624    c7.299-1.604,14.875-2.474,22.646-2.474c58.167,0,105.483,47.316,105.483,105.484c0,5.553-0.433,10.997-1.264,16.322    c37.297-23.207,61.445-64.176,61.445-125.16C417.814,184.367,360.949,126.366,303.173,97.537z M283.592,84.492    c1.745-2.935,3.595-6.054,5.456-9.294c0.406,0.068,0.814,0.117,1.238,0.224c4.607,1.391,6.14,4.571,4.551,9.56    c-1.751,0.712-4.181,0.37-5.998,0.241C287.072,85.11,285.337,84.823,283.592,84.492z M297.803,94.927    c-2.395-1.116-4.78-2.18-7.172-3.201c6.832,0.785,13.41,0.164,17.131-3.152c2.747,4.667-5.784,5.942-9.379,6.336    C298.177,94.927,298,94.922,297.803,94.927z M180.306,300.031v-0.104c0.017,0.021,0.04,0.027,0.063,0.048    C180.346,299.998,180.33,300.021,180.306,300.031z M151.813,415.966c2.202,6.54,5.089,12.738,8.544,18.594    c-5.262,0.984-10.662,1.554-16.202,1.554c-48.97,0-88.664-39.703-88.664-88.667c0-48.965,39.694-88.663,88.664-88.663    c27.797,0,52.584,12.812,68.839,32.826c-6.539,2.263-12.747,5.199-18.574,8.733c-12.581-13.428-30.42-21.855-50.266-21.855    c-38.089,0-68.961,30.878-68.961,68.964c0,38.085,30.872,68.969,68.961,68.969C146.749,416.409,149.299,416.24,151.813,415.966z     M160.549,334.39c-8.785,14.741-13.928,31.882-13.928,50.25c0,5.085,0.502,10.057,1.261,14.943h-8.988v-69.828    c-4.713,1.428-10.447,2.123-17.289,2.123h-4.929v-19.142h4.929c15.825,0,19.054-7.294,20.102-12.766l0.761-3.994h18.082V334.39z     M249.217,295.977c-48.968,0-88.668,39.699-88.668,88.663c0,48.957,39.695,88.662,88.668,88.662    c48.969,0,88.662-39.705,88.662-88.662C337.869,335.676,298.177,295.977,249.217,295.977z M249.217,453.608    c-38.087,0-68.961-30.883-68.961-68.969c0-38.08,30.874-68.964,68.961-68.964c38.085,0,68.958,30.884,68.958,68.964    C318.175,422.726,287.302,453.608,249.217,453.608z M247.516,333.169h18.09v103.602h-21.656v-69.827    c-4.72,1.43-10.444,2.134-17.292,2.134h-4.926v-19.142h4.926c15.83,0,19.052-7.294,20.114-12.771L247.516,333.169z"></path>
                </symbol>

                <!-- slides -->

                <symbol id="svg_query_cluster" viewBox="0 0 600 150">
                    <use y="25" width="100" height="100" fill="var(--green-color)" xlink:href="#svg_user" />
                    <path stroke="white" d="M 125 75 L 275 75" marker-end="url(#arrowhead)"/>
                    <g transform="translate(300 0)">
                        <use width="100" height="100" fill="var(--blue-color)" xlink:href="#svg_database" />
                        <use x="200" width="100" height="100" fill="var(--blue-color)" xlink:href="#svg_database" />
                        <use x="100" y="50" width="100" height="100" fill="var(--blue-color)" xlink:href="#svg_database" />
                    </g>
                </symbol>
                <symbol id="svg_query_node" viewBox="0 0 600 100">
                    <use width="100" height="100" fill="var(--green-color)" xlink:href="#svg_user" />
                    <path stroke="white" d="M 125 50 L 375 50" marker-end="url(#arrowhead)"/>
                    <use x="400" width="100" height="100" fill="var(--blue-color)" xlink:href="#svg_database" />
                </symbol>

                <symbol id="svg_query_scale_top" viewBox="0 0 400 100">
                    <defs>
                        <symbol id="svg_query_scale_top_db_process" viewBox="0 0 100 100">
                            <use width="100" height="100" fill="var(--blue-color)" xlink:href="#svg_database" />
                            <use x="70" y="70" width="30" height="30" fill="var(--cyan-color)" xlink:href="#svg_process" />
                        </symbol>
                    </defs>
                    <use width="100" height="100" xlink:href="#svg_query_scale_top_db_process" />
                    <use x="150" width="100" height="100" xlink:href="#svg_query_scale_top_db_process" />
                    <use x="300" width="100" height="100" xlink:href="#svg_query_scale_top_db_process" />
                </symbol>
                <symbol id="svg_query_scale_bot" viewBox="0 0 400 200">
                    <path stroke="white" d="M 50 0 L 190 75" marker-end="url(#arrowhead)"/>
                    <path stroke="white" d="M 200 0 L 200 75" marker-end="url(#arrowhead)"/>
                    <path stroke="white" d="M 350 0 L 210 75" marker-end="url(#arrowhead)"/>
                    <use x="150" y="100" width="100" height="100" fill="var(--violet-color)" xlink:href="#svg_process" />
                </symbol>

                <symbol id="svg_mapper_job" viewBox="0 0 550 320">
                    <g>
                        <use y="-25" width="175" height="175" fill="var(--blue-color)" xlink:href="#svg_flight_ticket" />
                        <use y="72.5" width="175" height="175" fill="var(--blue-color)" xlink:href="#svg_flight_ticket" />
                        <use y="170" width="175" height="175" fill="var(--blue-color)" xlink:href="#svg_flight_ticket" />
                    </g>
                    <path stroke="white" d="M 225 160 L 275 160" marker-end="url(#arrowhead)"/>
                    <g transform="translate(300 50)">
                        <rect width="250" height="220" fill="var(--cyan-color)" />
                        <rect width="100" height="220" fill="white" opacity="0.1"/>
                        <g transform="translate(25 50)">
                            <text font-size="40" fill="white">
                                <tspan x="0" y="0">AA</tspan>
                                <tspan x="0" y="50">UK</tspan>
                                <tspan x="0" y="100">US</tspan>
                                <tspan x="0" y="150">...</tspan>
                            </text>
                        </g>
                        <g transform="translate(125 50)">
                            <text font-size="40" fill="white">
                                <tspan x="0" y="0">125</tspan>
                                <tspan x="0" y="50">-15</tspan>
                                <tspan x="0" y="100">68</tspan>
                                <tspan x="0" y="150">...</tspan>
                            </text>
                        </g>
                    <g>
                </symbol>

                <symbol id="svg_grouper_job" viewBox="0 0 500 320">
                    <g>
                        <rect width="70" height="90" fill="var(--cyan-color)" />
                        <rect width="30" height="90" fill="white" opacity="0.1"/>
                        <rect y="110" width="70" height="90" fill="var(--cyan-color)" />
                        <rect y="110" width="30" height="90" fill="white" opacity="0.1"/>
                        <rect y="220" width="70" height="90" fill="var(--cyan-color)" />
                        <rect y="220" width="30" height="90" fill="white" opacity="0.1"/>
                        <g transform="translate(5 20)">
                            <text font-size="15" fill="white">
                                <tspan x="0" y="0" font-weight="bold">AA</tspan>
                                <tspan x="0" y="20">UK<tspan>
                                <tspan x="0" y="40">US</tspan>
                                <tspan x="0" y="60">...</tspan>
                                <tspan x="0" y="110">JJ</tspan>
                                <tspan x="0" y="130" font-weight="bold">AA</tspan>
                                <tspan x="0" y="150">US</tspan>
                                <tspan x="0" y="170">...</tspan>
                                <tspan x="0" y="220" font-weight="bold">AA</tspan>
                                <tspan x="0" y="240">JJ</tspan>
                                <tspan x="0" y="260" font-weight="bold">AA</tspan>
                                <tspan x="0" y="280">...</tspan>
                            </text>
                        </g>
                        <g transform="translate(40 20)">
                            <text font-size="15" fill="white">
                                <tspan x="0" y="0" font-weight="bold">125</tspan>
                                <tspan x="0" y="20">-15</tspan>
                                <tspan x="0" y="40">68</tspan>
                                <tspan x="0" y="60">...</tspan>
                                <tspan x="0" y="110">37</tspan>
                                <tspan x="0" y="130" font-weight="bold">75</tspan>
                                <tspan x="0" y="150">32</tspan>
                                <tspan x="0" y="170">...</tspan>
                                <tspan x="0" y="220" font-weight="bold">-27</tspan>
                                <tspan x="0" y="240">33</tspan>
                                <tspan x="0" y="260" font-weight="bold">68</tspan>
                                <tspan x="0" y="280">...</tspan>
                            </text>
                        </g>
                    </g>
                    <path stroke="white" d="M 125 160 L 275 160" marker-end="url(#arrowhead)"/>
                    <g transform="translate(300 0)">
                        <rect width="200" height="320" fill="var(--red-color)" />
                        <rect width="200" height="70" fill="white" opacity="0.1"/>
                        <g transform="translate(25 50)">
                            <text fill="white">
                                <tspan x="0" y="0" font-weight="bold">AA</tspan>
                                <tspan x="0" y="70">125</tspan>
                                <tspan x="0" y="120">75</tspan>
                                <tspan x="0" y="170">-27</tspan>
                                <tspan x="0" y="220">68</tspan>
                            </text>
                        </g>
                    </g>
                </symbol>

                <symbol id="svg_reducer_job" viewBox="0 0 500 320">
                    <g>
                        <rect width="200" height="320" fill="var(--red-color)" />
                        <rect width="200" height="70" fill="white" opacity="0.1"/>
                        <g transform="translate(25 50)">
                            <text fill="white">
                                <tspan x="0" y="0" font-weight="bold">AA</tspan>
                                <tspan x="0" y="70">125</tspan>
                                <tspan x="0" y="120">75</tspan>
                                <tspan x="0" y="170">-27</tspan>
                                <tspan x="0" y="220">68</tspan>
                            </text>
                        </g>
                    </g>
                    <path stroke="white" d="M 225 160 L 275 160" marker-end="url(#arrowhead)"/>
                    <g transform="translate(300 75)">
                        <rect width="200" height="170" fill="var(--violet-color)" />
                        <rect width="200" height="70" fill="white" opacity="0.1"/>
                        <g transform="translate(25 50)">
                            <text fill="white">
                                <tspan x="0" y="0" font-weight="bold">AA</tspan>
                                <tspan x="0" y="70">241</tspan>
                            </text>
                        </g>
                    </g>
                </symbol>

                <symbol id="svg_mapreduce" viewBox="0 0 1100 500">
                    <path stroke="white" stroke-dasharray="10,10" d="M 300 0 L 300 500" />
                    <path stroke="white" stroke-dasharray="10,10" d="M 500 0 L 500 500" />
                    <path stroke="white" stroke-dasharray="10,10" d="M 700 0 L 700 500" />
                    <path stroke="white" stroke-dasharray="10,10" d="M 900 0 L 900 500" />
                    <g>
                        <use y="150" width="100" height="100" fill="var(--blue-color)" xlink:href="#svg_box" />
                        <text font-size="50" y="480" fill="white">Split Inputs</text>
                        <g transform="translate(100 0)">
                            <path stroke="white" d="M 10 200 L 90 50" marker-end="url(#arrowhead)"/>
                            <path stroke="white" d="M 10 200 L 90 200" marker-end="url(#arrowhead)"/>
                            <path stroke="white" d="M 10 200 L 90 350" marker-end="url(#arrowhead)"/>
                        </g>
                        <g transform="translate(200 0)">
                            <use width="100" height="100" fill="var(--blue-color)" xlink:href="#svg_documents" />
                            <use y="150" width="100" height="100" fill="var(--blue-color)" xlink:href="#svg_documents" />
                            <use y="300" width="100" height="100" fill="var(--blue-color)" xlink:href="#svg_documents" />
                        </g>
                    </g>
                    <g transform="translate(300 0)">
                        <rect width="200" height="500" fill="white" opacity="0.1" />
                        <text font-size="30" x="20" y="430" fill="white" font-weight="bold">&lt;key, value&gt;</text>
                        <text font-size="50" x="50" y="480" fill="white" font-weight="bold">Map</text>
                        <use width="100" height="100" fill="var(--cyan-color)" xlink:href="#svg_process" />
                        <use y="150" width="100" height="100" fill="var(--cyan-color)" xlink:href="#svg_process" />
                        <use y="300" width="100" height="100" fill="var(--cyan-color)" xlink:href="#svg_process" />
                        <g transform="translate(100 0)">
                            <use width="100" height="100" fill="var(--cyan-color)" xlink:href="#svg_kvdocument" />
                            <use y="150" width="100" height="100" fill="var(--cyan-color)" xlink:href="#svg_kvdocument" />
                            <use y="300" width="100" height="100" fill="var(--cyan-color)" xlink:href="#svg_kvdocument" />
                        </g>
                    </g>
                    <g transform="translate(500 0)">
                        <text font-size="30" x="0" y="430" fill="white" font-weight="bold">&lt;groupby key&gt;</text>
                        <text font-size="50" x="20" y="480" fill="white">Shuffle</text>
                        <path stroke="white" d="M 10 50 L 90 40" marker-end="url(#arrowhead)"/>
                        <path stroke="white" d="M 10 50 L 90 140" marker-end="url(#arrowhead)"/>
                        <path stroke="white" d="M 10 50 L 90 240" marker-end="url(#arrowhead)"/>
                        <path stroke="white" d="M 10 50 L 90 340" marker-end="url(#arrowhead)"/>
                        <path stroke="white" d="M 10 200 L 90 50" marker-end="url(#arrowhead)"/>
                        <path stroke="white" d="M 10 200 L 90 150" marker-end="url(#arrowhead)"/>
                        <path stroke="white" d="M 10 200 L 90 250" marker-end="url(#arrowhead)"/>
                        <path stroke="white" d="M 10 200 L 90 350" marker-end="url(#arrowhead)"/>
                        <path stroke="white" d="M 10 350 L 90 60" marker-end="url(#arrowhead)"/>
                        <path stroke="white" d="M 10 350 L 90 160" marker-end="url(#arrowhead)"/>
                        <path stroke="white" d="M 10 350 L 90 260" marker-end="url(#arrowhead)"/>
                        <path stroke="white" d="M 10 350 L 90 360" marker-end="url(#arrowhead)"/>
                        <g transform="translate(100 0)">
                            <use y="5" width="100" height="90" fill="var(--red-color)" xlink:href="#svg_groupdocument" />
                            <use y="105" width="100" height="90" fill="var(--red-color)" xlink:href="#svg_groupdocument" />
                            <use y="205" width="100" height="90" fill="var(--red-color)" xlink:href="#svg_groupdocument" />
                            <use y="305" width="100" height="90" fill="var(--red-color)" xlink:href="#svg_groupdocument" />
                        </g>
                    </g>
                    <g transform="translate(700 0)">
                        <rect width="200" height="500" fill="white" opacity="0.1" />
                        <text font-size="30" x="15" y="430" fill="white" font-weight="bold">&lt;aggregate&gt;</text>
                        <text font-size="50" x="15" y="480" fill="white" font-weight="bold">Reduce</text>
                        <use y="5" width="100" height="90" fill="var(--violet-color)" xlink:href="#svg_process" />
                        <use y="105" width="100" height="90" fill="var(--violet-color)" xlink:href="#svg_process" />
                        <use y="205" width="100" height="90" fill="var(--violet-color)" xlink:href="#svg_process" />
                        <use y="305" width="100" height="90" fill="var(--violet-color)" xlink:href="#svg_process" />
                        <g transform="translate(100 0)">
                            <use y="5" width="100" height="90" fill="var(--violet-color)" xlink:href="#svg_reducedocument" />
                            <use y="105" width="100" height="90" fill="var(--violet-color)" xlink:href="#svg_reducedocument" />
                            <use y="205" width="100" height="90" fill="var(--violet-color)" xlink:href="#svg_reducedocument" />
                            <use y="305" width="100" height="90" fill="var(--violet-color)" xlink:href="#svg_reducedocument" />
                        </g>
                    </g>
                    <g transform="translate(900 0)">
                        <text font-size="50" x="50" y="480" fill="white">Collect</text>
                        <path stroke="white" d="M 10 50 L 90 185" marker-end="url(#arrowhead)"/>
                        <path stroke="white" d="M 10 150 L 90 195" marker-end="url(#arrowhead)"/>
                        <path stroke="white" d="M 10 250 L 90 205" marker-end="url(#arrowhead)"/>
                        <path stroke="white" d="M 10 350 L 90 215" marker-end="url(#arrowhead)"/>
                        <use x="100" y="150" width="100" height="100" fill="var(--yellow-color)" xlink:href="#svg_profit" />
                    </g>
                </symbol>

                <symbol id="svg_recursive_reduce" viewBox="0 0 1000 500">
                    <path stroke="white" stroke-dasharray="5,2" d="M 0 200 L 600 200" />
                    <path stroke="white" stroke-dasharray="10,10" d="M 200 0 L 200 500" />
                    <path stroke="white" stroke-dasharray="10,10" d="M 400 0 L 400 500" />
                    <path stroke="white" stroke-dasharray="10,10" d="M 600 0 L 600 500" />
                    <path stroke="white" stroke-dasharray="10,10" d="M 800 0 L 800 500" />
                    <g>
                        <rect width="200" height="500" fill="white" opacity="0.1" />
                        <text font-size="30" x="20" y="430" fill="white" font-weight="bold">&lt;key, value&gt;</text>
                        <text font-size="50" x="50" y="480" fill="white" font-weight="bold">Map</text>
                        <use y="50" width="100" height="100" fill="var(--cyan-color)" xlink:href="#svg_process" />
                        <use y="250" width="100" height="100" fill="var(--cyan-color)" xlink:href="#svg_process" />
                        <g transform="translate(100 0)">
                            <use y="50" width="100" height="100" fill="var(--cyan-color)" xlink:href="#svg_kvdocument" />
                            <use y="250" width="100" height="100" fill="var(--cyan-color)" xlink:href="#svg_kvdocument" />
                        </g>
                    </g>
                    <g transform="translate(200 0)">
                        <text font-size="30" x="0" y="430" fill="white" font-weight="bold">&lt;groupby key&gt;</text>
                        <text font-size="50" x="20" y="480" fill="white">Shuffle</text>
                        <path stroke="white" d="M 10 100 L 90 50" marker-end="url(#arrowhead)"/>
                        <path stroke="white" d="M 10 100 L 90 150" marker-end="url(#arrowhead)"/>
                        <path stroke="white" d="M 10 300 L 90 250" marker-end="url(#arrowhead)"/>
                        <path stroke="white" d="M 10 300 L 90 350" marker-end="url(#arrowhead)"/>
                        <g transform="translate(100 0)">
                            <use y="5" width="90" height="90" fill="var(--red-color)" xlink:href="#svg_groupdocument" />
                            <use y="105" width="90" height="90" fill="var(--red-color)" xlink:href="#svg_groupdocument" />
                            <use y="205" width="90" height="90" fill="var(--red-color)" xlink:href="#svg_groupdocument" />
                            <use y="305" width="90" height="90" fill="var(--red-color)" xlink:href="#svg_groupdocument" />
                        </g>
                    </g>
                    <g transform="translate(400 0)">
                        <rect width="200" height="500" fill="white" opacity="0.1" />
                        <text font-size="30" x="15" y="430" fill="white" font-weight="bold">&lt;aggregate&gt;</text>
                        <text font-size="50" x="15" y="480" fill="white" font-weight="bold">Reduce</text>
                        <use y="5" width="100" height="90" fill="var(--violet-color)" xlink:href="#svg_process" />
                        <use y="105" width="100" height="90" fill="var(--violet-color)" xlink:href="#svg_process" />
                        <use y="205" width="100" height="90" fill="var(--violet-color)" xlink:href="#svg_process" />
                        <use y="305" width="100" height="90" fill="var(--violet-color)" xlink:href="#svg_process" />
                        <g transform="translate(100 0)">
                            <use y="5" width="100" height="90" fill="var(--violet-color)" xlink:href="#svg_reducedocument" />
                            <use y="105" width="100" height="90" fill="var(--violet-color)" xlink:href="#svg_reducedocument" />
                            <use y="205" width="100" height="90" fill="var(--violet-color)" xlink:href="#svg_reducedocument" />
                            <use y="305" width="100" height="90" fill="var(--violet-color)" xlink:href="#svg_reducedocument" />
                        </g>
                    </g>
                    <g transform="translate(600 0)">
                        <text font-size="30" x="0" y="430" fill="white" font-weight="bold">&lt;groupby key&gt;</text>
                        <text font-size="50" x="20" y="480" fill="white">Shuffle</text>
                        <path stroke="white" d="M 10 50 L 90 95" marker-end="url(#arrowhead)"/>
                        <path stroke="white" d="M 10 150 L 90 295" marker-end="url(#arrowhead)"/>
                        <path stroke="white" d="M 10 250 L 90 105" marker-end="url(#arrowhead)"/>
                        <path stroke="white" d="M 10 350 L 90 305" marker-end="url(#arrowhead)"/>
                        <g transform="translate(100 0)">
                            <use y="50" width="100" height="100" fill="var(--red-color)" xlink:href="#svg_groupdocument" />
                            <use y="250" width="100" height="100" fill="var(--red-color)" xlink:href="#svg_groupdocument" />
                        </g>
                    </g>
                    <g transform="translate(800 0)">
                        <rect width="200" height="500" fill="white" opacity="0.1" />
                        <text font-size="30" x="15" y="430" fill="white" font-weight="bold">&lt;aggregate&gt;</text>
                        <text font-size="50" x="15" y="480" fill="white" font-weight="bold">Reduce</text>
                        <use y="50" width="100" height="100" fill="var(--violet-color)" xlink:href="#svg_process" />
                        <use y="250" width="100" height="100" fill="var(--violet-color)" xlink:href="#svg_process" />
                        <g transform="translate(100 0)">
                            <use y="50" width="100" height="100" fill="var(--violet-color)" xlink:href="#svg_reducedocument" />
                            <use y="250" width="100" height="100" fill="var(--violet-color)" xlink:href="#svg_reducedocument" />
                        </g>
                    </g>
                </symbol>

                <symbol id="svg_reduce_associative" viewBox="0 0 620 50">
                    <use x="65" y="0" width="50" height="50" fill="var(--violet-color)" xlink:href="#svg_process" />
                    <use x="190" y="0" width="50" height="50" fill="var(--violet-color)" xlink:href="#svg_process" />
                    <use x="375" y="0" width="50" height="50" fill="var(--violet-color)" xlink:href="#svg_process" />
                    <use x="500" y="0" width="50" height="50" fill="var(--violet-color)" xlink:href="#svg_process" />
                    <g transform="translate(0 45)">
                        <text font-size="50" fill="white" font-weight="bold">
                            <tspan x="0" y="0">( A</tspan>
                            <tspan x="125" y="0">B )</tspan>
                            <tspan x="250" y="0">C = A</tspan>
                            <tspan x="435" y="0">( B</tspan>
                            <tspan x="560" y="0">C )</tspan>
                        </text>
                    </g>
                </symbol>

                <symbol id="svg_af_match" viewBox="0 0 500 320">
                    <g transform="translate(200 0)">
                        <rect width="100" height="320" fill="var(--blue-color)" />
                        <text transform="rotate(90)" x="10" y="-10" font-size="50" fill="white" font-weight="bold">$match</text>
                    </g>
                    <g>
                        <use width="100" height="100" fill="white" xlink:href="#svg_document" />
                        <path stroke="white" d="M 110 50 L 190 50" marker-end="url(#arrowhead)"/>
                    </g>
                    <g transform="translate(0 110)">
                        <use width="100" height="100" fill="white" xlink:href="#svg_document" />
                        <path stroke="white" d="M 110 50 L 190 50" marker-end="url(#arrowhead)"/>
                        <path stroke="white" d="M 310 50 L 390 50" marker-end="url(#arrowhead)"/>
                        <use x="400" width="100" height="100" fill="white" xlink:href="#svg_document" />
                    </g>
                    <g transform="translate(0 220)">
                        <use width="100" height="100" fill="white" xlink:href="#svg_document" />
                        <path stroke="white" d="M 110 50 L 190 50" marker-end="url(#arrowhead)"/>
                    </g>
                </symbol>

                <symbol id="svg_af_project" viewBox="0 0 500 320">
                    <g transform="translate(200 0)">
                        <rect width="100" height="320" fill="var(--violet-color)" />
                        <text transform="rotate(90)" x="10" y="-10" font-size="50" fill="white" font-weight="bold">$project</text>
                    </g>
                    <g>
                        <use width="100" height="100" fill="white" xlink:href="#svg_document" />
                        <path stroke="white" d="M 110 50 L 190 50" marker-end="url(#arrowhead)"/>
                        <path stroke="white" d="M 310 50 L 390 50" marker-end="url(#arrowhead)"/>
                        <use x="400" width="100" height="100" fill="var(--yellow-color)" xlink:href="#svg_document" />
                    </g>
                    <g transform="translate(0 110)">
                        <use width="100" height="100" fill="white" xlink:href="#svg_document" />
                        <path stroke="white" d="M 110 50 L 190 50" marker-end="url(#arrowhead)"/>
                        <path stroke="white" d="M 310 50 L 390 50" marker-end="url(#arrowhead)"/>
                        <use x="400" width="100" height="100" fill="var(--yellow-color)" xlink:href="#svg_document" />
                    </g>
                    <g transform="translate(0 220)">
                        <use width="100" height="100" fill="white" xlink:href="#svg_document" />
                        <path stroke="white" d="M 110 50 L 190 50" marker-end="url(#arrowhead)"/>
                        <path stroke="white" d="M 310 50 L 390 50" marker-end="url(#arrowhead)"/>
                        <use x="400" width="100" height="100" fill="var(--yellow-color)" xlink:href="#svg_document" />
                    </g>
                </symbol>

                <symbol id="svg_af_group" viewBox="0 0 500 320">
                    <g transform="translate(200 0)">
                        <rect width="100" height="320" fill="var(--orange-color)" />
                        <text transform="rotate(90)" x="10" y="-10" font-size="50" fill="white" font-weight="bold">$group</text>
                    </g>
                    <g>
                        <use width="100" height="100" fill="white" xlink:href="#svg_document" />
                        <path stroke="white" d="M 110 50 L 190 50" marker-end="url(#arrowhead)"/>
                    </g>
                    <g transform="translate(0 110)">
                        <use width="100" height="100" fill="white" xlink:href="#svg_document" />
                        <path stroke="white" d="M 110 50 L 190 50" marker-end="url(#arrowhead)"/>
                    </g>
                    <g transform="translate(0 220)">
                        <use width="100" height="100" fill="white" xlink:href="#svg_document" />
                        <path stroke="white" d="M 110 50 L 190 50" marker-end="url(#arrowhead)"/>
                    </g>

                    <g transform="translate(300 0)">
                        <path stroke="white" d="M 10 50 L 90 100" marker-end="url(#arrowhead)"/>
                        <path stroke="white" d="M 10 160 L 90 110" marker-end="url(#arrowhead)"/>
                        <use x="100" y="55" width="100" height="100" fill="var(--yellow-color)" xlink:href="#svg_document" />

                        <path stroke="white" d="M 10 270 L 90 270" marker-end="url(#arrowhead)"/>
                        <use x="100" y="220" width="100" height="100" fill="var(--yellow-color)" xlink:href="#svg_document" />
                    </g>
                </symbol>

                <symbol id="svg_af_unwind" viewBox="0 0 700 320">
                    <g transform="translate(400 0)">
                        <rect width="100" height="320" fill="var(--green-color)" />
                        <text transform="rotate(90)" x="10" y="-10" font-size="50" fill="white" font-weight="bold">$unwind: cpn</text>
                    </g>
                    <g>
                        <use width="300" height="300" fill="white" xlink:href="#svg_empty_document" />
                        <text x="65" y="50" font-size="30" fill="white" font-weight="bold">cpn:</text>
                        <g transform="translate(120 0)">
                            <use y="30" width="70" height="70" fill="var(--blue-color)" xlink:href="#svg_document" />
                            <use y="110" width="70" height="70" fill="var(--red-color)" xlink:href="#svg_document" />
                            <use y="190" width="70" height="70" fill="var(--cyan-color)" xlink:href="#svg_document" />
                        </g>
                        <path stroke="white" d="M 310 150 L 390 150" marker-end="url(#arrowhead)"/>
                    </g>
                    <g transform="translate(500 0)">
                        <path stroke="white" d="M 10 50 L 90 50" marker-end="url(#arrowhead)"/>
                        <use x="100" width="100" height="100" fill="var(--yellow-color)" xlink:href="#svg_empty_document" />
                        <text x="122" y="17" font-size="10" fill="white" font-weight="bold">cpn:</text>
                        <use x="125" y="25" width="50" height="50" fill="var(--blue-color)" xlink:href="#svg_document" />
                    </g>
                    <g transform="translate(500 110)">
                        <path stroke="white" d="M 10 50 L 90 50" marker-end="url(#arrowhead)"/>
                        <use x="100" width="100" height="100" fill="var(--yellow-color)" xlink:href="#svg_empty_document" />
                        <text x="122" y="17" font-size="10" fill="white" font-weight="bold">cpn:</text>
                        <use x="125" y="25" width="50" height="50" fill="var(--red-color)" xlink:href="#svg_document" />
                    </g>
                    <g transform="translate(500 220)">
                        <path stroke="white" d="M 10 50 L 90 50" marker-end="url(#arrowhead)"/>
                        <use x="100" width="100" height="100" fill="var(--yellow-color)" xlink:href="#svg_empty_document" />
                        <text x="122" y="17" font-size="10" fill="white" font-weight="bold">cpn:</text>
                        <use x="125" y="25" width="50" height="50" fill="var(--cyan-color)" xlink:href="#svg_document" />
                    </g>
                </symbol>

                <symbol id="svg_sql_to_agg_framework" viewBox="0 0 1000 450">
                    <g>
                        <rect y="5" width="350" height="80" style="fill: var(--orange-color);stroke: var(--orange-color); stroke-width:1; fill-opacity:0.5; stroke-opacity:1" />
                        <rect y="85" width="350" height="20" style="fill: var(--red-color);stroke: var(--red-color); stroke-width:1; fill-opacity:0.5; stroke-opacity:1" />
                        <rect y="105" width="350" height="20" style="fill: var(--green-color);stroke: var(--green-color); stroke-width:1; fill-opacity:0.5; stroke-opacity:1" />
                        <rect y="125" width="350" height="20" style="fill: var(--blue-color);stroke: var(--blue-color); stroke-width:1; fill-opacity:0.5; stroke-opacity:1" />
                        <rect y="145" width="350" height="40" style="fill: var(--orange-color);stroke: var(--orange-color); stroke-width:1; fill-opacity:0.5; stroke-opacity:1" />
                        <rect y="185" width="350" height="20" style="fill: var(--blue-color);stroke: var(--blue-color); stroke-width:1; fill-opacity:0.5; stroke-opacity:1" />
                        <rect y="205" width="350" height="20" style="fill: var(--yellow-color);stroke: var(--yellow-color); stroke-width:1; fill-opacity:0.5; stroke-opacity:1" />
                        <rect y="225" width="350" height="20" style="fill: var(--cyan-color);stroke: var(--cyan-color); stroke-width:1; fill-opacity:0.5; stroke-opacity:1" />

                        <text font-family="consolas" font-size="18" fill="white" font-weight="bold">
                            <tspan x="0" y="20">SELECT</tspan>
                            <tspan x="20" y="40">fra_id, env_nb, env_ver, cpn.id,</tspan>
                            <tspan x="20" y="60">sum(cpn.tax) AS tax,</tspan>
                            <tspan x="20" y="80">sum(cpn.fee) AS fee</tspan>
                            <tspan x="0" y="100">FROM documents</tspan>
                            <tspan x="0" y="120">JOIN coupons ON doc_id</tspan>
                            <tspan x="0" y="140">WHERE iss_date > '12-JAN-15'</tspan>
                            <tspan x="0" y="160">GROUP BY</tspan>
                            <tspan x="20" y="180">fra_id, env_nb, env_ver, cpn.id</tspan>
                            <tspan x="0" y="200">HAVING tax > 0 OR fee > 0</tspan>
                            <tspan x="0" y="220">ORDER BY fra_id DESC</tspan>
                            <tspan x="0" y="240">LIMIT 4, 8;</tspan>
                        </text>
                    <g>

                    <g transform="translate(650 0)">
                        <rect y="5" width="350" height="20" style="fill: var(--red-color);stroke: var(--red-color); stroke-width:1; fill-opacity:0.5; stroke-opacity:1" />
                        <rect y="25" width="350" height="60" style="fill: var(--blue-color);stroke: var(--blue-color); stroke-width:1; fill-opacity:0.5; stroke-opacity:1" />
                        <rect y="85" width="350" height="20" style="fill: var(--green-color);stroke: var(--green-color); stroke-width:1; fill-opacity:0.5; stroke-opacity:1" />
                        <rect y="105" width="350" height="200" style="fill: var(--orange-color);stroke: var(--orange-color); stroke-width:1; fill-opacity:0.5; stroke-opacity:1" />
                        <rect y="305" width="350" height="80" style="fill: var(--blue-color);stroke: var(--blue-color); stroke-width:1; fill-opacity:0.5; stroke-opacity:1" />
                        <rect y="385" width="350" height="20" style="fill: var(--yellow-color);stroke: var(--yellow-color); stroke-width:1; fill-opacity:0.5; stroke-opacity:1" />
                        <rect y="405" width="350" height="40" style="fill: var(--cyan-color);stroke: var(--cyan-color); stroke-width:1; fill-opacity:0.5; stroke-opacity:1" />

                        <text font-family="consolas" font-size="18" fill="white" font-weight="bold">
                            <tspan x="0" y="20">db.documents.aggregate([</tspan>
                                <tspan x="20" y="40">{ $match: { </tspan>
                                    <tspan x="40" y="60">iss_date: { $gt: "2015-01-12" }</tspan>
                                <tspan x="20" y="80">} },</tspan>
                                <tspan x="20" y="100">{ $unwind: "$cpn" },</tspan>
                                <tspan x="20" y="120">{ $group: { </tspan>
                                    <tspan x="40" y="140">_id: { </tspan>
                                        <tspan x="60" y="160">fra_id: 1,</tspan>
                                        <tspan x="60" y="180">env_nb: 1,</tspan>
                                        <tspan x="60" y="200">env_ver: 1,</tspan>
                                        <tspan x="60" y="220">cpn.id: 1</tspan>
                                    <tspan x="40" y="240">},</tspan>
                                    <tspan x="40" y="260">tax: { $sum: "$cpn.tax" }</tspan>
                                    <tspan x="40" y="280">fee: { $sum: "$cpn.fee" }</tspan>
                                <tspan x="20" y="300">} },</tspan>
                                <tspan x="20" y="320">{ $match: { $or: [ </tspan>
                                    <tspan x="40" y="340">{ tax: { $gt: 0 } },</tspan>
                                    <tspan x="40" y="360">{ fee: { $gt: 0 } },</tspan>
                                <tspan x="20" y="380">} },</tspan>
                                <tspan x="20" y="400">{ $sort: { fra_id: -1 } },</tspan>
                                <tspan x="20" y="420">{ $skip: 8 },</tspan>
                                <tspan x="20" y="440">{ $limit: 4 }])</tspan>
                        </text>
                    </g>

                    <g>
                        <path d="M 350  45 L 500  45 C 515  45, 515  45, 515  60 L 515 190 C 515 205, 515 205, 530 205 L 650 205" stroke="var(--orange-color)" stroke-width="2" fill="none" />
                        <path d="M 350  95 L 530  95 C 545  95, 545  95, 545  70 L 545  30 C 545  15, 545  15, 560  15 L 650  15" stroke="var(--red-color)" stroke-width="2" fill="none" />
                        <path d="M 350 115 L 560 115 C 575 115, 575 115, 575 100 L 575 110 C 575  95, 575  95, 590  95 L 650  95" stroke="var(--green-color)" stroke-width="2" fill="none" stroke-dasharray="10,10"/>
                        <path d="M 350 135 L 590 135 C 605 135, 605 135, 605 120 L 605  70 C 605  55, 605  55, 620  55 L 650  55" stroke="var(--blue-color)" stroke-width="2" fill="none" />
                        <path d="M 350 165 L 470 165 C 485 165, 485 165, 485 180 L 485 190 C 485 205, 485 205, 500 205 L 650 205" stroke="var(--orange-color)" stroke-width="2" fill="none" />
                        <path d="M 350 195 L 440 195 C 455 195, 455 195, 455 210 L 455 330 C 455 345, 455 345, 470 345 L 650 345" stroke="var(--blue-color)" stroke-width="2" fill="none" />
                        <path d="M 350 215 L 410 215 C 425 215, 425 215, 425 230 L 425 380 C 425 395, 425 395, 440 395 L 650 395" stroke="var(--yellow-color)" stroke-width="2" fill="none" />
                        <path d="M 350 235 L 380 235 C 395 235, 395 235, 395 250 L 395 410 C 395 425, 395 425, 410 425 L 650 425" stroke="var(--cyan-color)" stroke-width="2" fill="none" />
                    </g>
                </symbol>
            </defs>
        </svg>
    </body>
</html>
